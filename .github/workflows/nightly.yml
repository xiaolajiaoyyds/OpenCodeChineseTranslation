name: Nightly Build

on:
  push:
    paths:
      - '.github/workflows/nightly.yml'
  schedule:
    # æ¯å°æ—¶æ£€æµ‹ä¸€æ¬¡ä¸Šæ¸¸æ›´æ–° (é¿å¼€æ•´ç‚¹é«˜å³°æœŸ)
    - cron: '16 * * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æ„å»ºï¼ˆè·³è¿‡ commit æ•°é‡æ£€æµ‹ï¼‰'
        required: false
        type: boolean
        default: false
      min_commits:
        description: 'è§¦å‘æ„å»ºçš„æœ€å° commit æ•°é‡'
        required: false
        type: number
        default: 5

permissions:
  contents: write

env:
  UPSTREAM_REPO: anomalyco/opencode
  UPSTREAM_BRANCH: dev
  MIN_COMMITS_THRESHOLD: 5

jobs:
  check-upstream:
    name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      upstream_sha: ${{ steps.check.outputs.upstream_sha }}
      upstream_date: ${{ steps.check.outputs.upstream_date }}
      commit_count: ${{ steps.check.outputs.commit_count }}
      changelog: ${{ steps.check.outputs.changelog }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
        id: check
        run: |
          echo "=== æ£€æŸ¥ä¸Šæ¸¸æ›´æ–° ==="

          UPSTREAM_SHA=$(git ls-remote https://github.com/${{ env.UPSTREAM_REPO }}.git refs/heads/${{ env.UPSTREAM_BRANCH }} | cut -f1)
          echo "ä¸Šæ¸¸ SHA: $UPSTREAM_SHA"

          UPSTREAM_DATE=$(TZ='Asia/Shanghai' date +"%Y%m%d-%H%M")
          echo "æ„å»ºæ—¶é—´æˆ³: $UPSTREAM_DATE"

          LAST_SHA=""
          if [ -f ".nightly-state" ]; then
            LAST_SHA=$(cat .nightly-state | head -1)
            echo "ä¸Šæ¬¡æ„å»º SHA: $LAST_SHA"
          else
            echo "æœªæ‰¾åˆ°ä¸Šæ¬¡æ„å»ºçŠ¶æ€"
          fi

          MIN_COMMITS=${{ github.event.inputs.min_commits || env.MIN_COMMITS_THRESHOLD }}
          echo "æœ€å° commit é˜ˆå€¼: $MIN_COMMITS"

          SHOULD_BUILD="false"
          COMMIT_COUNT=0
          CHANGELOG=""

          if [ "${{ github.event.inputs.force_build }}" == "true" ]; then
            echo "å¼ºåˆ¶æ„å»º"
            SHOULD_BUILD="true"
          elif [ -z "$LAST_SHA" ]; then
            echo "é¦–æ¬¡ nightly æ„å»º"
            SHOULD_BUILD="true"
          elif [ "$UPSTREAM_SHA" != "$LAST_SHA" ]; then
            echo "ä¸Šæ¸¸æœ‰æ–° commitï¼Œè®¡ç®—å·®å¼‚..."

            git clone --depth 200 --branch ${{ env.UPSTREAM_BRANCH }} https://github.com/${{ env.UPSTREAM_REPO }}.git /tmp/upstream 2>/dev/null || true

            if [ -d "/tmp/upstream" ]; then
              cd /tmp/upstream

              COMMIT_COUNT=$(git rev-list --count $LAST_SHA..$UPSTREAM_SHA 2>/dev/null || echo "0")
              echo "æ–°å¢ commit æ•°: $COMMIT_COUNT"

              if [ "$COMMIT_COUNT" -ge "$MIN_COMMITS" ]; then
                echo "Commit æ•° ($COMMIT_COUNT) >= é˜ˆå€¼ ($MIN_COMMITS)ï¼Œè§¦å‘æ„å»º"
                SHOULD_BUILD="true"

                CHANGELOG=$(git log $LAST_SHA..$UPSTREAM_SHA --format="- %s (\`%h\`)" | head -50)
              else
                echo "Commit æ•° ($COMMIT_COUNT) < é˜ˆå€¼ ($MIN_COMMITS)ï¼Œè·³è¿‡æ„å»º"
              fi

              cd -
            else
              echo "å…‹éš†ä¸Šæ¸¸å¤±è´¥ï¼Œè§¦å‘æ„å»º"
              SHOULD_BUILD="true"
            fi
          else
            echo "æ— æ›´æ–° (SHA æœªå˜)"
          fi

          if [ "$SHOULD_BUILD" == "true" ] && [ -z "$CHANGELOG" ] && [ -d "/tmp/upstream" ]; then
            cd /tmp/upstream
            CHANGELOG=$(git log -20 --format="- %s (\`%h\`)")
            cd -
          fi

          echo "should_build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "upstream_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
          echo "upstream_date=$UPSTREAM_DATE" >> $GITHUB_OUTPUT
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "=== æ£€æŸ¥å®Œæˆ ==="
          echo "æ˜¯å¦æ„å»º: $SHOULD_BUILD"

  build-opencode:
    name: æ„å»º OpenCode ä¸­æ–‡ç‰ˆ
    runs-on: ubuntu-latest
    needs: check-upstream
    if: needs.check-upstream.outputs.should_build == 'true'
    strategy:
      matrix:
        include:
          - platform: windows-x64
          - platform: linux-x64
          - platform: linux-arm64
          - platform: darwin-x64
          - platform: darwin-arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.5'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…è„šæœ¬ä¾èµ–
        run: |
          cd scripts
          npm ci

      - name: å…‹éš† OpenCode æºç 
        run: |
          git clone --depth 1 --branch ${{ env.UPSTREAM_BRANCH }} https://github.com/${{ env.UPSTREAM_REPO }}.git opencode-zh-CN
          cd opencode-zh-CN
          bun install

      - name: åº”ç”¨ä¸­æ–‡ç¿»è¯‘
        run: |
          cd scripts
          node bin/opencodenpm apply --skip-translate --skip-verify --skip-quality-check

      - name: æ„å»º OpenCode
        env:
          OPENCODE_CHANNEL: nightly
          OPENCODE_VERSION: nightly-${{ needs.check-upstream.outputs.upstream_date }}
        run: |
          cd opencode-zh-CN/packages/opencode
          bun run build --single

      - name: æ‰“åŒ…äº§ç‰©
        env:
          NIGHTLY_DATE: ${{ needs.check-upstream.outputs.upstream_date }}
        run: |
          VERSION="nightly"
          PLATFORM=${{ matrix.platform }}
          PACKAGE_NAME="opencode-zh-CN-${VERSION}-${PLATFORM}"

          echo "=== æ‰“åŒ… ${PACKAGE_NAME} ==="

          BUILD_DIR="opencode-zh-CN/packages/opencode/dist/opencode-${PLATFORM}/bin"

          echo "æŸ¥æ‰¾æ„å»ºäº§ç‰©: ${BUILD_DIR}"
          ls -la ${BUILD_DIR}/ || echo "æ„å»ºç›®å½•æœªæ‰¾åˆ°"

          mkdir -p dist

          if [ "$PLATFORM" == "windows-x64" ]; then
            BINARY="${BUILD_DIR}/opencode.exe"
          else
            BINARY="${BUILD_DIR}/opencode"
          fi

          if [ -f "$BINARY" ]; then
            zip -j dist/${PACKAGE_NAME}.zip "$BINARY"
            echo "âœ“ åˆ›å»º dist/${PACKAGE_NAME}.zip"
            ls -la dist/
          else
            echo "âŒ äºŒè¿›åˆ¶æœªæ‰¾åˆ°: $BINARY"
            find opencode-zh-CN -name "opencode*" -type f 2>/dev/null | head -20
            exit 1
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: opencode-${{ matrix.platform }}
          path: dist/*.zip

  release:
    name: åˆ›å»º/æ›´æ–° Nightly Release
    needs: [check-upstream, build-opencode]
    if: needs.check-upstream.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: è®¡ç®—æ–°ç‰ˆæœ¬å·
        id: newver
        run: |
          # è·å–å½“å‰æ±‰åŒ–ç‰ˆæœ¬å·
          CURRENT_ZH=$(node -p 'require("./opencode-i18n/config.json").version')
          echo "å½“å‰æ±‰åŒ–ç‰ˆæœ¬: $CURRENT_ZH"

          # æå–åŸºç¡€ç‰ˆæœ¬å’Œè¡¥ä¸ç‰ˆæœ¬
          BASE=$(echo "$CURRENT_ZH" | sed 's/-zh-v.*//')
          PATCH=$(echo "$CURRENT_ZH" | grep -oP '(?<=-zh-v)[0-9.]+' || echo "0")

          # è®¡ç®—æ–°çš„è¡¥ä¸ç‰ˆæœ¬ (æ¯æ¬¡ nightly æ„å»ºé€’å¢ 0.1)
          NEW_PATCH=$(echo "$PATCH + 0.1" | bc)
          NEW_VERSION="${BASE}-zh-v${NEW_PATCH}"

          echo "æ–°æ±‰åŒ–ç‰ˆæœ¬: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆæ±‰åŒ–å˜æ›´æŠ¥å‘Š
        id: i18n_changes
        run: |
          echo "=== æ£€æµ‹æ±‰åŒ–å˜æ›´ ==="

          # è·å–ä¸Šæ¬¡æ„å»ºçš„æ±‰åŒ–ç»Ÿè®¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          LAST_STATS=""
          if [ -f ".nightly-i18n-stats" ]; then
            LAST_STATS=$(cat .nightly-i18n-stats)
            echo "ä¸Šæ¬¡ç»Ÿè®¡: $LAST_STATS"
          fi

          # ç»Ÿè®¡å½“å‰æ±‰åŒ–æ–‡ä»¶
          CURRENT_STATS=$(find opencode-i18n -name "*.json" -not -path "*/node_modules/*" | wc -l | tr -d ' ')
          echo "å½“å‰æ–‡ä»¶æ•°: $CURRENT_STATS"

          # ç»Ÿè®¡ç¿»è¯‘æ¡ç›®æ€»æ•°
          TOTAL_TRANSLATIONS=$(node -e "
            const fs = require('fs');
            const path = require('path');
            let total = 0;
            function countKeys(obj) {
              for (const key in obj) {
                if (typeof obj[key] === 'object' && obj[key] !== null) {
                  countKeys(obj[key]);
                } else {
                  total++;
                }
              }
            }
            function processDir(dir) {
              const files = fs.readdirSync(dir);
              files.forEach(file => {
                const filePath = path.join(dir, file);
                const stat = fs.statSync(filePath);
                if (stat.isDirectory()) {
                  processDir(filePath);
                } else if (file.endsWith('.json') && file !== 'config.json') {
                  try {
                    const content = JSON.parse(fs.readFileSync(filePath, 'utf8'));
                    countKeys(content);
                  } catch (e) {}
                }
              });
            }
            processDir('opencode-i18n');
            console.log(total);
          ")

          echo "ç¿»è¯‘æ¡ç›®æ•°: $TOTAL_TRANSLATIONS"

          # æ£€æµ‹æ–°å¢æ–‡ä»¶
          NEW_FILES=""
          if [ -f ".nightly-i18n-files" ]; then
            NEW_FILES=$(comm -13 <(sort .nightly-i18n-files) <(find opencode-i18n -name "*.json" -not -path "*/node_modules/*" -not -name "config.json" | sort) | head -20)
          fi

          # ç”Ÿæˆå˜æ›´æ‘˜è¦
          CHANGES_SUMMARY="æœ¬æ¬¡æ±‰åŒ–æ›´æ–°ç»Ÿè®¡ï¼š
          - ğŸ“ æ±‰åŒ–æ–‡ä»¶ï¼š${CURRENT_STATS} ä¸ª
          - âœï¸ ç¿»è¯‘æ¡ç›®ï¼š${TOTAL_TRANSLATIONS} æ¡"

          if [ -n "$NEW_FILES" ]; then
            FILE_COUNT=$(echo "$NEW_FILES" | wc -l | tr -d ' ')
            CHANGES_SUMMARY="${CHANGES_SUMMARY}
          - âœ¨ æ–°å¢æ–‡ä»¶ï¼š${FILE_COUNT} ä¸ª"

            # åˆ—å‡ºæ–°å¢æ–‡ä»¶ï¼ˆæœ€å¤šæ˜¾ç¤º 10 ä¸ªï¼‰
            FILES_LIST=$(echo "$NEW_FILES" | head -10 | sed 's|opencode-i18n/||' | sed 's/^/  - /')
            CHANGES_SUMMARY="${CHANGES_SUMMARY}

          **æ–°å¢æ±‰åŒ–æ–‡ä»¶ï¼š**
          ${FILES_LIST}"

            if [ "$FILE_COUNT" -gt 10 ]; then
              CHANGES_SUMMARY="${CHANGES_SUMMARY}
          - ... åŠå…¶ä»– $((FILE_COUNT - 10)) ä¸ªæ–‡ä»¶"
            fi
          fi

          # è¾“å‡ºåˆ° GitHub Output
          {
            echo "summary<<EOF"
            echo "$CHANGES_SUMMARY"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          echo "$CHANGES_SUMMARY"

      - name: æ›´æ–°ç‰ˆæœ¬å·å’Œæ–‡æ¡£
        env:
          NEW_VERSION: ${{ steps.newver.outputs.version }}
          I18N_CHANGES: ${{ steps.i18n_changes.outputs.summary }}
        run: |
          echo "=== æ›´æ–°ç‰ˆæœ¬å·åˆ° $NEW_VERSION ==="

          # æ›´æ–° opencode-i18n/config.json
          node -e "const fs=require('fs');const path='opencode-i18n/config.json';const cfg=JSON.parse(fs.readFileSync(path));cfg.version=process.env.NEW_VERSION;fs.writeFileSync(path,JSON.stringify(cfg,null,2)+'\n')"

          # å®‰è£… scripts ä¾èµ–å¹¶åŒæ­¥ç‰ˆæœ¬
          cd scripts && npm ci && cd ..
          node scripts/bin/opencodenpm version --sync

          # æ›´æ–° README.md ä¸­çš„ç‰ˆæœ¬å·
          sed -i "s/v[0-9]*\.[0-9]*\.[0-9]*-zh-v[0-9.]*/v${NEW_VERSION}/g" README.md

          # æ›´æ–° CHANGELOG.mdï¼ˆåŒ…å«æ±‰åŒ–å˜æ›´ä¿¡æ¯ï¼‰
          node -e "
            const fs = require('fs');
            const path = 'CHANGELOG.md';
            const version = process.env.NEW_VERSION;
            const changes = process.env.I18N_CHANGES || 'è‡ªåŠ¨æ„å»ºç‰ˆæœ¬';
            const commitCount = '${{ needs.check-upstream.outputs.commit_count }}';
            const today = new Date().toISOString().slice(0,10);

            const entry = \`## [${version}] - ${today}

          ### ğŸŒ™ Nightly Build

          - è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼ˆåŒ…å« ${commitCount} ä¸ªä¸Šæ¸¸ commitsï¼‰

          ### ğŸ“Š æ±‰åŒ–æ›´æ–°

          ${changes}

          \`;

            const content = fs.readFileSync(path, 'utf8');
            if (content.includes(\`## [${version}]\`)) {
              process.exit(0);
            }

            const marker = '---\n\n';
            const idx = content.indexOf(marker);
            if (idx === -1) {
              fs.writeFileSync(path, entry + content);
              process.exit(0);
            }

            const insertPos = idx + marker.length;
            const updated = content.slice(0, insertPos) + entry + content.slice(insertPos);
            fs.writeFileSync(path, updated);
          "

          echo "âœ“ ç‰ˆæœ¬å·å’Œæ–‡æ¡£æ›´æ–°å®Œæˆ"

      - name: ä¿å­˜æ±‰åŒ–ç»Ÿè®¡
        run: |
          # ä¿å­˜å½“å‰æ±‰åŒ–æ–‡ä»¶åˆ—è¡¨å’Œç»Ÿè®¡ï¼Œç”¨äºä¸‹æ¬¡å¯¹æ¯”
          find opencode-i18n -name "*.json" -not -path "*/node_modules/*" -not -name "config.json" | sort > .nightly-i18n-files
          find opencode-i18n -name "*.json" -not -path "*/node_modules/*" | wc -l > .nightly-i18n-stats
          echo "âœ“ æ±‰åŒ–ç»Ÿè®¡å·²ä¿å­˜"

      - name: æäº¤ç‰ˆæœ¬å·å˜æ›´
        env:
          NEW_VERSION: ${{ steps.newver.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add package.json scripts/package.json opencode-i18n/config.json README.md CHANGELOG.md
          git commit -m "chore: nightly build -> $NEW_VERSION [skip ci]

          åŒ…å« ${{ needs.check-upstream.outputs.commit_count }} ä¸ªä¸Šæ¸¸æ›´æ–°
          ä¸Šæ¸¸ commit: ${{ needs.check-upstream.outputs.upstream_sha }}" || echo "æ— å˜æ›´éœ€æäº¤"

          git push || echo "æ¨é€å¤±è´¥"

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: opencode-*
          path: dist
          merge-multiple: true

      - name: åˆ—å‡ºäº§ç‰©
        run: |
          echo "=== ä¸‹è½½çš„æ„å»ºäº§ç‰© ==="
          find dist -type f | head -50
          ls -la dist/ || true

      - name: ç”Ÿæˆ Release è¯´æ˜
        env:
          NIGHTLY_DATE: ${{ needs.check-upstream.outputs.upstream_date }}
          UPSTREAM_SHA: ${{ needs.check-upstream.outputs.upstream_sha }}
          COMMIT_COUNT: ${{ needs.check-upstream.outputs.commit_count }}
          CHANGELOG: ${{ needs.check-upstream.outputs.changelog }}
        run: |
          cat > release_notes.md <<'EOF'
          ## ğŸŒ™ Nightly Build - è‡ªåŠ¨è·Ÿè¿›ä¸Šæ¸¸æ›´æ–°

          > âš ï¸ **è­¦å‘Š**: è¿™æ˜¯è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªç»å……åˆ†æµ‹è¯•çš„åŠŸèƒ½ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚
          > å¦‚éœ€ç¨³å®šç‰ˆæœ¬ï¼Œè¯·å‰å¾€ [Releases](../../releases) é¡µé¢ä¸‹è½½æ­£å¼ç‰ˆã€‚

          ---

          ### ğŸ“Š æ„å»ºä¿¡æ¯

          | é¡¹ç›® | å€¼ |
          |------|-----|
          EOF

          echo "| ä¸Šæ¸¸åˆ†æ”¯ | \`${{ env.UPSTREAM_BRANCH }}\` |" >> release_notes.md
          echo "| ä¸Šæ¸¸ Commit | [\`${UPSTREAM_SHA:0:8}\`](https://github.com/${{ env.UPSTREAM_REPO }}/commit/$UPSTREAM_SHA) |" >> release_notes.md
          echo "| æœ¬æ¬¡åŒ…å« Commits | ${COMMIT_COUNT:-unknown} |" >> release_notes.md
          echo "| æ„å»ºæ—¶é—´ | $(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M CST") |" >> release_notes.md

          cat >> release_notes.md <<'EOF'

          ---

          ### ğŸ“¦ ä¸‹è½½

          | å¹³å° | æ±‰åŒ–ç‰ˆ OpenCode |
          |------|-----------------|
          | Windows x64 | `opencode-zh-CN-nightly-windows-x64.zip` |
          | macOS Apple Silicon | `opencode-zh-CN-nightly-darwin-arm64.zip` |
          | macOS Intel | `opencode-zh-CN-nightly-darwin-x64.zip` |
          | Linux x64 | `opencode-zh-CN-nightly-linux-x64.zip` |
          | Linux ARM64 | `opencode-zh-CN-nightly-linux-arm64.zip` |

          ---

          ### ğŸ“ OpenCode å®˜æ–¹æ›´æ–°æ—¥å¿—

          ä»¥ä¸‹æ˜¯æœ¬æ¬¡æ„å»ºåŒ…å«çš„ä¸Šæ¸¸æ›´æ–°ï¼š

          EOF

          if [ -n "$CHANGELOG" ]; then
            echo "$CHANGELOG" >> release_notes.md
          else
            echo "_æ— æ³•è·å–æ›´æ–°æ—¥å¿—_" >> release_notes.md
          fi

          cat >> release_notes.md <<'EOF'

          ---

          ### ğŸ”„ è‡ªåŠ¨æ›´æ–°æœºåˆ¶

          - **æ£€æµ‹é¢‘ç‡**: æ¯å°æ—¶æ£€æµ‹ä¸€æ¬¡ä¸Šæ¸¸æ›´æ–°
          - **è§¦å‘æ¡ä»¶**: ç´¯è®¡ â‰¥5 ä¸ªæ–° commit æ—¶è‡ªåŠ¨æ„å»º
          - **æ›´æ–°æ–¹å¼**: å›ºå®š `nightly` tagï¼Œæ¯æ¬¡æ„å»ºè¦†ç›–æ›´æ–°

          > ğŸ’¡ æ­¤ Release ä¼šæŒç»­æ›´æ–°ï¼Œä¸‹è½½é“¾æ¥å§‹ç»ˆæŒ‡å‘æœ€æ–°æ„å»ºã€‚
          EOF

          echo "=== ç”Ÿæˆçš„ Release è¯´æ˜ ==="
          cat release_notes.md

      - name: åˆ é™¤æ—§çš„ nightly release
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 0
          delete_tag_pattern: nightly
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: åˆ›å»º Nightly Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: "ğŸŒ™ Nightly Build (è‡ªåŠ¨æ›´æ–°)"
          body_path: release_notes.md
          files: |
            dist/*
          draft: false
          prerelease: true
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ›´æ–° nightly çŠ¶æ€
        env:
          UPSTREAM_SHA: ${{ needs.check-upstream.outputs.upstream_sha }}
        run: |
          echo "$UPSTREAM_SHA" > .nightly-state
          echo "æ›´æ–° .nightly-state: $UPSTREAM_SHA"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .nightly-state
          git commit -m "chore: update nightly build state [skip ci]

          Upstream: ${{ env.UPSTREAM_REPO }}@${UPSTREAM_SHA:0:8}
          Commits: ${{ needs.check-upstream.outputs.commit_count }}" || echo "æ— å˜æ›´éœ€æäº¤"
          git push || echo "æ¨é€å¤±è´¥ï¼ŒçŠ¶æ€å°†åœ¨ä¸‹æ¬¡è¿è¡Œæ—¶æ›´æ–°"

  notify-skip:
    name: æŠ¥å‘Šè·³è¿‡åŸå› 
    runs-on: ubuntu-latest
    needs: check-upstream
    if: needs.check-upstream.outputs.should_build != 'true'
    steps:
      - name: æŠ¥å‘ŠçŠ¶æ€
        env:
          COMMIT_COUNT: ${{ needs.check-upstream.outputs.commit_count }}
        run: |
          echo "=== Nightly Build å·²è·³è¿‡ ==="
          echo "åŸå› : æ–° commit æ•°é‡ä¸è¶³"
          echo "å½“å‰æ–° commit: ${COMMIT_COUNT:-0}"
          echo "é˜ˆå€¼: ${{ env.MIN_COMMITS_THRESHOLD }}"
          echo ""
          echo "å½“ä¸Šæ¸¸ç´¯è®¡ â‰¥${{ env.MIN_COMMITS_THRESHOLD }} ä¸ªæ–° commit æ—¶å°†è§¦å‘æ„å»ºã€‚"
          echo "ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘å¹¶è®¾ç½® 'force_build=true' è·³è¿‡æ­¤æ£€æŸ¥ã€‚"
