name: Nightly Build

on:
  push:
    paths:
      - '.github/workflows/nightly.yml'
  schedule:
    # æ¯å°æ—¶æ£€æµ‹ä¸€æ¬¡ä¸Šæ¸¸æ›´æ–° (æ”¹ä¸ºæ¯å°æ—¶çš„ç¬¬ 16 åˆ†é’Ÿï¼Œé¿å¼€æ•´ç‚¹é«˜å³°æœŸ)
    - cron: '16 * * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æ„å»ºï¼ˆè·³è¿‡ commit æ•°é‡æ£€æµ‹ï¼‰'
        required: false
        type: boolean
        default: false
      min_commits:
        description: 'è§¦å‘æ„å»ºçš„æœ€å° commit æ•°é‡'
        required: false
        type: number
        default: 5

permissions:
  contents: write

env:
  UPSTREAM_REPO: anomalyco/opencode
  UPSTREAM_BRANCH: dev
  MIN_COMMITS_THRESHOLD: 5  # ç´¯è®¡è¶…è¿‡æ­¤æ•°é‡æ‰è§¦å‘æ„å»º

jobs:
  check-upstream:
    name: Check Upstream Updates
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      upstream_sha: ${{ steps.check.outputs.upstream_sha }}
      upstream_date: ${{ steps.check.outputs.upstream_date }}
      commit_count: ${{ steps.check.outputs.commit_count }}
      changelog: ${{ steps.check.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for upstream updates
        id: check
        run: |
          echo "=== Checking upstream updates ==="
          
          # è·å–ä¸Šæ¸¸æœ€æ–° commit
          UPSTREAM_SHA=$(git ls-remote https://github.com/${{ env.UPSTREAM_REPO }}.git refs/heads/${{ env.UPSTREAM_BRANCH }} | cut -f1)
          echo "Upstream SHA: $UPSTREAM_SHA"
          
          # è·å–å½“å‰æ—¥æœŸï¼ˆCSTï¼‰
          UPSTREAM_DATE=$(TZ='Asia/Shanghai' date +"%Y%m%d-%H%M")
          echo "Build timestamp: $UPSTREAM_DATE"
          
          # è¯»å–ä¸Šæ¬¡æ„å»ºçš„ commit SHA
          LAST_SHA=""
          if [ -f ".nightly-state" ]; then
            LAST_SHA=$(cat .nightly-state | head -1)
            echo "Last built SHA: $LAST_SHA"
          else
            echo "No previous build state found"
          fi
          
          # è·å– commit æ•°é‡é˜ˆå€¼
          MIN_COMMITS=${{ github.event.inputs.min_commits || env.MIN_COMMITS_THRESHOLD }}
          echo "Min commits threshold: $MIN_COMMITS"
          
          # åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
          SHOULD_BUILD="false"
          COMMIT_COUNT=0
          CHANGELOG=""
          
          if [ "${{ github.event.inputs.force_build }}" == "true" ]; then
            echo "Force build requested"
            SHOULD_BUILD="true"
          elif [ -z "$LAST_SHA" ]; then
            echo "First nightly build"
            SHOULD_BUILD="true"
          elif [ "$UPSTREAM_SHA" != "$LAST_SHA" ]; then
            echo "Upstream has new commits, calculating diff..."
            
            # Clone ä¸Šæ¸¸ä»“åº“è·å–è¯¦ç»†ä¿¡æ¯
            git clone --depth 200 --branch ${{ env.UPSTREAM_BRANCH }} https://github.com/${{ env.UPSTREAM_REPO }}.git /tmp/upstream 2>/dev/null || true
            
            if [ -d "/tmp/upstream" ]; then
              cd /tmp/upstream
              
              # è®¡ç®— commit å·®å¼‚æ•°é‡
              COMMIT_COUNT=$(git rev-list --count $LAST_SHA..$UPSTREAM_SHA 2>/dev/null || echo "0")
              echo "New commits since last build: $COMMIT_COUNT"
              
              # åˆ¤æ–­æ˜¯å¦è¾¾åˆ°é˜ˆå€¼
              if [ "$COMMIT_COUNT" -ge "$MIN_COMMITS" ]; then
                echo "Commit count ($COMMIT_COUNT) >= threshold ($MIN_COMMITS), triggering build"
                SHOULD_BUILD="true"
                
                # ç”Ÿæˆ changelog (æœ€å¤š 50 æ¡)
                CHANGELOG=$(git log $LAST_SHA..$UPSTREAM_SHA --format="- %s (\`%h\`)" | head -50)
              else
                echo "Commit count ($COMMIT_COUNT) < threshold ($MIN_COMMITS), skipping build"
              fi
              
              cd -
            else
              echo "Failed to clone upstream, triggering build anyway"
              SHOULD_BUILD="true"
            fi
          else
            echo "No updates detected (SHA unchanged)"
          fi
          
          # å¦‚æœå¼ºåˆ¶æ„å»ºä½†æ²¡æœ‰ changelogï¼Œç”Ÿæˆæœ€è¿‘çš„ changelog
          if [ "$SHOULD_BUILD" == "true" ] && [ -z "$CHANGELOG" ] && [ -d "/tmp/upstream" ]; then
            cd /tmp/upstream
            CHANGELOG=$(git log -20 --format="- %s (\`%h\`)")
            cd -
          fi
          
          echo "should_build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "upstream_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
          echo "upstream_date=$UPSTREAM_DATE" >> $GITHUB_OUTPUT
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          
          # Changelog å¯èƒ½å¾ˆé•¿ï¼Œä½¿ç”¨å¤šè¡Œè¾“å‡º
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "=== Check complete ==="
          echo "Should build: $SHOULD_BUILD"

  build-cli:
    name: Build CLI Tool
    runs-on: ubuntu-latest
    needs: check-upstream
    if: needs.check-upstream.outputs.should_build == 'true'
    strategy:
      matrix:
        include:
          - os: windows
            arch: amd64
            ext: .exe
          - os: linux
            arch: amd64
            ext: ""
          - os: darwin
            arch: arm64
            ext: ""
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build CLI
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        run: |
          cd cli-go
          go build -ldflags="-s -w" -o ../dist/opencode-cli-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }} .

      - name: Upload CLI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*

  build-opencode:
    name: Build OpenCode Chinese
    runs-on: ubuntu-latest
    needs: [check-upstream, build-cli]
    if: needs.check-upstream.outputs.should_build == 'true'
    strategy:
      matrix:
        include:
          - platform: windows-x64
            bun_target: bun-windows-x64
          - platform: linux-x64
            bun_target: bun-linux-x64
          - platform: linux-arm64
            bun_target: bun-linux-aarch64
          - platform: darwin-x64
            bun_target: bun-darwin-x64
          - platform: darwin-arm64
            bun_target: bun-darwin-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.5'

      - name: Build CLI for current platform
        run: |
          cd cli-go
          go build -o ../opencode-cli .

      - name: Clone OpenCode source
        run: |
          git clone --depth 1 --branch ${{ env.UPSTREAM_BRANCH }} https://github.com/${{ env.UPSTREAM_REPO }}.git opencode-zh-CN

      - name: Apply Chinese translation
        run: |
          ./opencode-cli apply

      - name: Build OpenCode
        run: |
          ./opencode-cli build --platform ${{ matrix.platform }} --deploy=false

      - name: Package
        env:
          NIGHTLY_DATE: ${{ needs.check-upstream.outputs.upstream_date }}
        run: |
          VERSION="nightly"
          PLATFORM=${{ matrix.platform }}
          PACKAGE_NAME="opencode-zh-CN-${VERSION}-${PLATFORM}"
          
          echo "=== Packaging ${PACKAGE_NAME} ==="
          
          BUILD_DIR="opencode-zh-CN/packages/opencode/dist/opencode-${PLATFORM}/bin"
          
          echo "Looking for build artifacts in: ${BUILD_DIR}"
          ls -la ${BUILD_DIR}/ || echo "Build dir not found"
          
          mkdir -p dist
          
          if [ "$PLATFORM" == "windows-x64" ]; then
            BINARY="${BUILD_DIR}/opencode.exe"
          else
            BINARY="${BUILD_DIR}/opencode"
          fi
          
          if [ -f "$BINARY" ]; then
            zip -j dist/${PACKAGE_NAME}.zip "$BINARY"
            echo "âœ“ Created dist/${PACKAGE_NAME}.zip"
            ls -la dist/
          else
            echo "âŒ Binary not found: $BINARY"
            find opencode-zh-CN -name "opencode*" -type f 2>/dev/null | head -20
            exit 1
          fi

      - name: Upload OpenCode Artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencode-${{ matrix.platform }}
          path: dist/*.zip

  release:
    name: Create/Update Nightly Release
    needs: [check-upstream, build-cli, build-opencode]
    if: needs.check-upstream.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download CLI Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: cli-*
          path: dist
          merge-multiple: true

      - name: Download OpenCode Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: opencode-*
          path: dist
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find dist -type f | head -50
          ls -la dist/ || true

      - name: Package i18n tool
        run: |
          zip -r dist/opencode-i18n-tool-nightly.zip \
            cli-go/ \
            install.ps1 \
            install.sh \
            README.md \
            CHANGELOG.md \
            -x "cli-go/.git/*" \
            -x "*.exe"

      - name: Generate Release Notes
        env:
          NIGHTLY_DATE: ${{ needs.check-upstream.outputs.upstream_date }}
          UPSTREAM_SHA: ${{ needs.check-upstream.outputs.upstream_sha }}
          COMMIT_COUNT: ${{ needs.check-upstream.outputs.commit_count }}
          CHANGELOG: ${{ needs.check-upstream.outputs.changelog }}
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸŒ™ Nightly Build - è‡ªåŠ¨è·Ÿè¿›ä¸Šæ¸¸æ›´æ–°
          
          > âš ï¸ **è­¦å‘Š**: è¿™æ˜¯è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªç»å……åˆ†æµ‹è¯•çš„åŠŸèƒ½ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚
          > å¦‚éœ€ç¨³å®šç‰ˆæœ¬ï¼Œè¯·å‰å¾€ [Releases](https://github.com/1186258278/OpenCodeChineseTranslation/releases) é¡µé¢ä¸‹è½½æ­£å¼ç‰ˆã€‚
          
          ---
          
          ### ğŸ“Š æ„å»ºä¿¡æ¯
          
          | é¡¹ç›® | å€¼ |
          |------|-----|
          EOF
          
          echo "| ä¸Šæ¸¸åˆ†æ”¯ | \`${{ env.UPSTREAM_BRANCH }}\` |" >> release_notes.md
          echo "| ä¸Šæ¸¸ Commit | [\`${UPSTREAM_SHA:0:8}\`](https://github.com/${{ env.UPSTREAM_REPO }}/commit/$UPSTREAM_SHA) |" >> release_notes.md
          echo "| æœ¬æ¬¡åŒ…å« Commits | ${COMMIT_COUNT:-unknown} |" >> release_notes.md
          echo "| æ„å»ºæ—¶é—´ | $(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M CST") |" >> release_notes.md
          
          cat >> release_notes.md << 'EOF'
          
          ---
          
          ### ğŸ“¦ ä¸‹è½½
          
          | å¹³å° | ç®¡ç†å·¥å…· (CLI) | æ±‰åŒ–ç‰ˆ OpenCode |
          |------|----------------|-----------------|
          | Windows x64 | `opencode-cli-windows-amd64.exe` | `opencode-zh-CN-nightly-windows-x64.zip` |
          | macOS Apple Silicon | `opencode-cli-darwin-arm64` | `opencode-zh-CN-nightly-darwin-arm64.zip` |
          | macOS Intel | `opencode-cli-darwin-amd64` | `opencode-zh-CN-nightly-darwin-x64.zip` |
          | Linux x64 | `opencode-cli-linux-amd64` | `opencode-zh-CN-nightly-linux-x64.zip` |
          | Linux ARM64 | `opencode-cli-linux-arm64` | `opencode-zh-CN-nightly-linux-arm64.zip` |
          
          > âš ï¸ **æ³¨æ„**: Windows ARM64 æš‚ä¸æ”¯æŒï¼ˆBun å°šæœªæä¾›å®˜æ–¹ Windows ARM64 æ„å»ºï¼‰
          
          ---
          
          ### ğŸ“ OpenCode å®˜æ–¹æ›´æ–°æ—¥å¿—
          
          ä»¥ä¸‹æ˜¯æœ¬æ¬¡æ„å»ºåŒ…å«çš„ä¸Šæ¸¸æ›´æ–°ï¼š
          
          EOF
          
          if [ -n "$CHANGELOG" ]; then
            echo "$CHANGELOG" >> release_notes.md
          else
            echo "_æ— æ³•è·å–æ›´æ–°æ—¥å¿—_" >> release_notes.md
          fi
          
          cat >> release_notes.md << 'EOF'
          
          ---
          
          ### ğŸ”„ è‡ªåŠ¨æ›´æ–°æœºåˆ¶
          
          - **æ£€æµ‹é¢‘ç‡**: æ¯å°æ—¶æ£€æµ‹ä¸€æ¬¡ä¸Šæ¸¸æ›´æ–°
          - **è§¦å‘æ¡ä»¶**: ç´¯è®¡ â‰¥5 ä¸ªæ–° commit æ—¶è‡ªåŠ¨æ„å»º
          - **æ›´æ–°æ–¹å¼**: å›ºå®š `nightly` tagï¼Œæ¯æ¬¡æ„å»ºè¦†ç›–æ›´æ–°
          
          > ğŸ’¡ æ­¤ Release ä¼šæŒç»­æ›´æ–°ï¼Œä¸‹è½½é“¾æ¥å§‹ç»ˆæŒ‡å‘æœ€æ–°æ„å»ºã€‚
          EOF
          
          echo "=== Generated Release Notes ==="
          cat release_notes.md

      - name: Delete old nightly release
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 0
          delete_tag_pattern: nightly
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Create Nightly Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: "ğŸŒ™ Nightly Build (è‡ªåŠ¨æ›´æ–°)"
          body_path: release_notes.md
          files: |
            dist/*
          draft: false
          prerelease: true
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update nightly state
        env:
          UPSTREAM_SHA: ${{ needs.check-upstream.outputs.upstream_sha }}
        run: |
          echo "$UPSTREAM_SHA" > .nightly-state
          echo "Updated .nightly-state with SHA: $UPSTREAM_SHA"
          
          # æäº¤çŠ¶æ€æ–‡ä»¶
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .nightly-state
          git commit -m "chore: update nightly build state [skip ci]

          Upstream: ${{ env.UPSTREAM_REPO }}@${UPSTREAM_SHA:0:8}
          Commits: ${{ needs.check-upstream.outputs.commit_count }}" || echo "No changes to commit"
          git push || echo "Push failed, state will be updated on next run"

  notify-skip:
    name: Report Skip Reason
    runs-on: ubuntu-latest
    needs: check-upstream
    if: needs.check-upstream.outputs.should_build != 'true'
    steps:
      - name: Report status
        env:
          COMMIT_COUNT: ${{ needs.check-upstream.outputs.commit_count }}
        run: |
          echo "=== Nightly Build Skipped ==="
          echo "Reason: Not enough new commits"
          echo "Current new commits: ${COMMIT_COUNT:-0}"
          echo "Threshold: ${{ env.MIN_COMMITS_THRESHOLD }}"
          echo ""
          echo "Build will trigger when upstream has â‰¥${{ env.MIN_COMMITS_THRESHOLD }} new commits."
          echo "You can also manually trigger with 'force_build=true' to skip this check."
